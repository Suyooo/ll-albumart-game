<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>LL! Guess That Album - Fix Attempt</title>
    <style>
        body {
            background-color: rgb(41, 37, 36);
            color: white;
            padding: .5em 1em;
        }

        #wrongbrowser, #success, #failure, #error, #nosuccess {
            display: none;
        }
    </style>
</head>
<body>
<div id="fixing">
    <b>Hello!</b> Your browser did something weird and locked you to an old version. Don't worry, you did nothing wrong
    - it's just your browser having a moment and refusing to check for game updates.<br><br>
    <div id="wait">
        Please wait... trying an automatic fix now! <span id="ticker">.</span>
    </div>
    <div id="success">
        The script on this page has tried an automatic fix, so please check whether it worked! Try reloading the game
        page and see whether the round now shows up correctly. (If you failed the error round, that round has now been
        removed from your statistics, too - sorry about making you fail, but due to what this problem was, replacing the
        image is literally the only way I could show an error message :( )<br><br>
        The error message should not show up again, even in the future! If the fix didn't work, or the error is showing
        up again, please message me on Twitter @Suyo_ or, if you prefer, send me a mail at me@suyo.be, so we can figure
        out how to get the game working properly for you!
    </div>
    <div id="failure">
        <div id="error">
            There was an error trying to automatically fix the problem. Please make sure you have an internet connection
            and refresh this page!<br><br>
        </div>
        <div id="nosuccess">
            The automatic fix sadly did not work. You can try manually deleting the cache of your browser app though -
            head to your phone's settings, the App list there, and look for your browser (it might also be listed as
            just "Internet" instead of the browser name). Tap that, then head into the Storage overview, and hit "Delete
            Cache" (do not hit "Delete Data"!)<br><br>
        </div>
        If that doesn't work, please message me on Twitter @Suyo_ or, if you prefer, send me a mail at me@suyo.be, so we
        can figure out how to get the game working again for you!
    </div>
</div>
<div id="wrongbrowser">
    It seems there is no LL! Guess That Album save data from today. Please make sure you are visiting this page using
    the same browser that you play on!<br><br>
    If that doesn't work, please message me on Twitter @Suyo_ or, if you prefer, send me a mail at me@suyo.be, so we can
    figure out how to get the game working again for you!
</div>

<script>
    (() => {
        const FIXDAY = 54;
        const DAY = Math.floor((Date.now() - 1667487600000) / 86400000);
        if (DAY !== FIXDAY) {
            document.getElementById("wait").style.display = "none";
            document.getElementById("success").style.display = "block";
            return;
        }
        console.log(DAY);

        const SAVE = JSON.parse(localStorage.getItem("llalbum-states"));
        if (SAVE === null || !SAVE.some(s => s.day === DAY)) {
            document.getElementById("fixing").style.display = "none";
            document.getElementById("wrongbrowser").style.display = "block";
            return;
        }
        const DAYIDX = SAVE.findIndex(s => s.day === DAY);
        if (SAVE[DAYIDX].cleared) {
            document.getElementById("wait").style.display = "none";
            document.getElementById("success").style.display = "block";
            return;
        }

        const ticker = document.getElementById("ticker");
        const ticker1 = () => {
            ticker.innerText = ".";
            setTimeout(ticker2, 500);
        };
        const ticker2 = () => {
            ticker.innerText = "..";
            setTimeout(ticker3, 500);
        };
        const ticker3 = () => {
            ticker.innerText = "...";
            setTimeout(ticker1, 500);
        };
        ticker1();

        fetch("/", {cache: "reload"})
            .then(response => {
                if (response.status !== 200) {
                    document.getElementById("wait").style.display = "none";
                    document.getElementById("failure").style.display = "block";
                    document.getElementById("error").style.display = "block";
                    return;
                }

                const downloadedTime = Date.parse(response.headers.get("Last-Modified"));
                console.log(downloadedTime);
                if (downloadedTime >= 1672068210000) {
                    fetch("/index", {cache: "reload"});
                    fetch("/index.html", {cache: "reload"});

                    const STATS = JSON.parse(localStorage.getItem("llalbum-statistics"));
                    localStorage.setItem("llalbum-fixbackup-states", JSON.stringify(SAVE));
                    localStorage.setItem("llalbum-fixbackup-statistics", JSON.stringify(STATS));
                    STATS.viewed -= 1;
                    if (SAVE[DAYIDX].finished) {
                        STATS.byFailCount[6] -= 1;
                        let curstreak = 0;
                        let i = DAYIDX - 1;
                        while (i > 0 && SAVE[i].cleared) {
                            curstreak++;
                            i--;
                        }
                        STATS.currentStreak = curstreak;
                    }
                    SAVE.splice(DAYIDX);
                    localStorage.setItem("llalbum-states", JSON.stringify(SAVE));
                    localStorage.setItem("llalbum-statistics", JSON.stringify(STATS));

                    document.getElementById("wait").style.display = "none";
                    document.getElementById("success").style.display = "block";
                } else {
                    document.getElementById("wait").style.display = "none";
                    document.getElementById("failure").style.display = "block";
                    document.getElementById("nosuccess").style.display = "block";
                }
            })
            .catch(err => {
                document.getElementById("wait").style.display = "none";
                document.getElementById("failure").style.display = "block";
                document.getElementById("error").style.display = "block";
                console.error(err);
            });
    })();
</script>
</body>
</html>